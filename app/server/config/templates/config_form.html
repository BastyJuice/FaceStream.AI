{% extends "layout.html" %}

{% block content %}
<!-- Nav tabs -->
<ul class="nav nav-tabs" id="configTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button"
                role="tab" aria-controls="settings" aria-selected="true">Settings
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="known-faces-tab" data-bs-toggle="tab" data-bs-target="#known-faces" type="button"
                role="tab" aria-controls="known-faces" aria-selected="false">Known Persons
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="notification-tab" data-bs-toggle="tab" data-bs-target="#notification" type="button"
                role="tab" aria-controls="notification" aria-selected="false">Notification-Service
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="eventlog-tab" data-bs-toggle="tab" data-bs-target="#eventlog" type="button"
                role="tab" aria-controls="eventlog" aria-selected="false">Eventlog
        </button>
    </li>
</ul>

<!-- Tab panes -->
<div class="tab-content">
    <!-- Einstellungen Tab -->
    <div class="tab-pane fade show active" id="settings" role="tabpanel" aria-labelledby="settings-tab">
        <form method="post" id="settings-form" class="needs-validation" novalidate>
            <div class="mt-3">
                <div class="row mb-3">
                    <!-- linker Bereich -->
                    <section class="col-md-6">
                        <h3>General Settings</h3>
                        <div class="alert alert-info mt-3" role="alert">
                            <strong>Manual Trigger API</strong>
                            <div class="mt-2">
                                Starts face recognition on demand (even if the interval is disabled).
                            </div>
                            <div class="mt-2">
                                <div><code>GET /trigger</code> or <code>POST /trigger</code> (defaults: 5s, 3 FPS)</div>
                                <div><code>/trigger?duration=30&amp;fps=3</code></div>
                                <div><code>/trigger?duration=30&amp;fps=2&amp;stop_on_match=1</code></div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col">
                                <label for="inputStreamURL" class="form-label">Input Stream URL</label>
                                <input type="text" class="form-control" id="inputStreamURL" name="input_stream_url"
                                       value="{{ config.input_stream_url }}" required>
                                <div class="invalid-feedback">
                                    Bitte geben Sie eine gültige URL ein.
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <!-- Input-Gruppe für Dropdown und Dimensionseingaben -->
                            <div class="col">
                                <label for="dropdownMenuButton1" class="form-label">Video Output Size</label>
                                <div class="input-group">
                                    <button class="btn btn-info dropdown-toggle" type="button"
                                            id="dropdownMenuButton1" data-bs-toggle="dropdown"
                                            aria-expanded="false">
                                        Preselect
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                                        <li><a class="dropdown-item" href="#" onclick="setSize(800, 600)">Small
                                            (SVGA 800x600)</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setSize(1024, 768)">Medium
                                            (XGA 1024x768)</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setSize(1280, 1024)">Large
                                            (SXGA 1280x1024)</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setSize(1600, 1200)">Extra
                                            Large (UXGA 1600x1200)</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setSize(2048, 1536)">Ultra
                                            Large (QXGA 2048x1536)</a></li>
                                    </ul>
                                    <input type="number" class="form-control" id="outputWidth" placeholder="Breite"
                                           name="output_width" value="{{ config.output_width }}" required>
                                    <input type="number" class="form-control" id="outputHeight" placeholder="Höhe"
                                           name="output_height" value="{{ config.output_height }}" required>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-8">
                                
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="enableStreamSuspend"
                                           name="enable_stream_suspend"
                                           {% if config.get('enable_stream_suspend', False) %}checked{% endif %}
                                           onchange="toggleStreamSuspendAvailability()">
                                    <label class="form-check-label" for="enableStreamSuspend">
                                        Enable Stream Suspend
                                    </label>
                                </div>
<div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="enableFaceRecognitionInterval"
                                           name="enable_face_recognition_interval"
                                           {% if config.get('enable_face_recognition_interval', True) %}checked{% endif %}
                                           onchange="toggleFaceRecognitionInterval()">
                                    <label class="form-check-label" for="enableFaceRecognitionInterval">
                                        Enable Face Recognition Interval
                                    </label>
                                </div>
                                <label class="form-label" for="face_recognition_interval">Face Recognition Interval
                                    (Delay)</label>
                                <input type="range" class="form-range" id="face_recognition_interval"
                                       name="face_recognition_interval" min="2" max="300"
                                       value="{{ config.face_recognition_interval }}"
                                       oninput="updateFaceRecognitionIntervalValue(this.value)"
                                       {% if not config.get('enable_face_recognition_interval', True) %}disabled{% endif %}>

                                <small> Every <span
                                        id="faceRecognitionIntervalValue">{{ config.face_recognition_interval }}</span></small>
                                frames
                            </div>

          <hr class="my-4">
          <h5>Face Recognition Tuning</h5>

          <div class="row">
            <div class="col-md-4">
              <label for="face_scale_factor" class="form-label">Detection Scale Factor</label>
              <input type="number" step="0.05" min="0.25" max="1.0" class="form-control" id="face_scale_factor" name="face_scale_factor" value="{{ config.get('face_scale_factor', 0.75) }}">
              <div class="form-text">Higher = more accurate, more CPU. Recommended: 0.75–1.0 for 720p.</div>
            </div>

            <div class="col-md-4">
              <label for="face_detection_model" class="form-label">Face Detection Model</label>
              <select class="form-select" id="face_detection_model" name="face_detection_model">
                <option value="hog" {% if config.get('face_detection_model', 'hog') == 'hog' %}selected{% endif %}>hog (fast)</option>
                <option value="cnn" {% if config.get('face_detection_model', 'hog') == 'cnn' %}selected{% endif %}>cnn (more accurate, slower)</option>
              </select>
            </div>

            <div class="col-md-4">
              <label for="face_match_threshold" class="form-label">Match Threshold</label>
              <input type="number" step="0.01" min="0.30" max="0.80" class="form-control" id="face_match_threshold" name="face_match_threshold" value="{{ config.get('face_match_threshold', 0.55) }}">
              <div class="form-text">Lower = stricter (more Unknown). Typical: 0.50–0.60.</div>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-4 form-check">
              <input class="form-check-input" type="checkbox" id="enable_clahe" name="enable_clahe" {% if config.get('enable_clahe', False) %}checked{% endif %}>
              <label class="form-check-label" for="enable_clahe">Enable low-light enhancement (CLAHE)</label>
            </div>

            <div class="col-md-4 form-check">
              <input class="form-check-input" type="checkbox" id="enable_blur_filter" name="enable_blur_filter" {% if config.get('enable_blur_filter', False) %}checked{% endif %}>
              <label class="form-check-label" for="enable_blur_filter">Skip blurry frames</label>
            </div>

            <div class="col-md-4">
              <label for="blur_threshold" class="form-label">Blur Threshold</label>
              <input type="number" step="1" min="0" max="5000" class="form-control" id="blur_threshold" name="blur_threshold" value="{{ config.get('blur_threshold', 100.0) }}">
              <div class="form-text">Higher = stricter blur filter (skips more frames). Typical: 80–150.</div>
            </div>
          </div>

                        </div>
                    </section>
                    <!-- Linie als Trenner -->
                    <div class="col-md-1 d-none d-md-block">
                        <div class="border-start border-2 h-100 mx-auto" style="width: 1px;"></div>
                    </div>
                    <!-- rechter Bereich -->
                    <section class="col-md-5">
                        <h3>Overlay Settings</h3>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="enableFaceOverlay" name="enable_face_overlay" {% if config.enable_face_overlay %}checked{% endif %}>
                            <label class="form-check-label" for="enableFaceOverlay">Show face boxes and names</label>
                        </div>
                        <div class="row">
                            <div class="col">
                                <div class="image-container">
                                    <img src="{{ url_for('static', filename='img/avatar2.webp') }}" alt="Avatar Face"
                                         class="img-fluid">
                                    <div class="colorOverlayContainer">
                                        <div class="overlay" id="colorOverlay"
                                             style="background-color: {{ rgba_overlay }};"></div>
                                        <div style="position: absolute; left: 0; color: white;">
                                            Name
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="p-3">
                                    <div class="mb-3">
                                        <label for="colorPicker" class="form-label">Select Color</label>
                                        <input type="color" class="form-control form-control-color" id="colorPicker"
                                               name="overlay_color" value="{{ hex_color }}">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3">
                                    <div class="mb-3">
                                        <label for="overlayTransparency" class="form-label mb-1">Transparency <span
                                                id="transparencyValue" class="badge bg-secondary">{{ transparency_value }}%</span></label>
                                        <input type="range" class="form-range" min="0" max="100"
                                               value="{{ transparency_value }}" id="overlayTransparency"
                                               name="overlay_transparency">

                                    </div>
                                </div>
                            </div>
                        </div>

                    </section>
                </div>

            </div>
        </form>
        <!-- Weitere Formularelemente und Submit-Button ... -->
    </div>

    <!-- Bekannte Gesichter Tab -->
    <div class="tab-pane fade" id="known-faces" role="tabpanel" aria-labelledby="known-faces-tab">
        <div class="mt-4">
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label for="newPersonName" class="form-label"><strong>New Person</strong></label>
                    <input type="text" class="form-control" id="newPersonName" placeholder="e.g. Norman">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-primary w-100" id="createPersonBtn">Create</button>
                </div>
                <div class="col-md-6 small text-muted">
                    Create people and then drag images directly into the matching box. Multiple images per person improve recognition.
                </div>
            </div>
        </div>

        <!-- People + images (updated via /list-faces) -->
        <div class="mt-4" id="personsContainer">
            {% include '_face_list.html' %}
        </div>
    </div>

    <div class="tab-pane fade" id="notification" role="tabpanel" aria-labelledby="notification-tab">
        <form method="post" id="notification-form" class="needs-validation" novalidate>
            <div class="row mt-3">
                <p class="alert alert-info">
                    <b>Note:</b> The messages are sent by the video server. You must use the host name of the video server if it is required for the message-receiving servers.
                </p>

                <div class="col-12 mt-4">
                    <h3>Loxone Virtual Text Input</h3>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="use_loxone_vti" name="use_loxone_vti"
                               {% if config.use_loxone_vti %}checked{% endif %} value="1">
                        <label class="form-check-label" for="use_loxone_vti">
                            Enable Loxone Virtual Text Input
                        </label>
                    </div>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="loxone_ip" class="form-label">IP</label>
                            <input type="text" class="form-control" id="loxone_ip" name="loxone_ip"
                                   value="{{config.loxone_ip}}" placeholder="192.168.1.10">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="loxone_user" class="form-label">User</label>
                            <input type="text" class="form-control" id="loxone_user" name="loxone_user"
                                   value="{{config.loxone_user}}" placeholder="admin">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="loxone_pass" class="form-label">Pass</label>
                            <input type="password" class="form-control" id="loxone_pass" name="loxone_pass"
                                   value="{{config.loxone_pass}}" placeholder="••••••••">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="loxone_text_input" class="form-label">Texteingang</label>
                            <input type="text" class="form-control" id="loxone_text_input" name="loxone_text_input"
                                   value="{{config.loxone_text_input}}" placeholder="VTI_Name">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 mb-2">
                            <button type="button" class="btn btn-outline-primary" id="loxone-test-btn">
                                Test Loxone (send "FaceStream.AI")
                            </button>
                            <span id="loxone-test-result" class="ms-2"></span>
                        </div>
                    </div>
                    <small class="text-muted">
                        Sends a GET request to Loxone: <code>http://&lt;user&gt;:&lt;pass&gt;@&lt;ip&gt;/dev/sps/io/&lt;Texteingang&gt;/&lt;name&gt;</code>
                        <br><br>
                    </small>
                </div>

                <!-- UDP Messaging Service Configuration -->
                <div class="col-md-6">
                    <h3>UDP Messaging Service</h3>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="use_udp" name="use_udp"
                               {% if config.use_udp %}checked{% endif %} value="1">
                        <label class="form-check-label" for="use_udp">
                            Enable UDP Messaging Service
                        </label>
                    </div>
                    <div class="mb-3">
                        <label for="udp_service_url" class="form-label">UDP Server</label>
                        <input type="text" class="form-control" id="udp_service_url" name="udp_service_url"
                               value="{{config.udp_service_url}}"
                               placeholder="Server Address">
                    </div>
                    <div class="mb-3">
                        <label for="udp_service_port" class="form-label">UDP Port</label>
                        <input type="number" class="form-control" id="udp_service_port" name="udp_service_port"
                               placeholder="Server Port"
                               value="{{config.udp_service_port}}">
                    </div>
                </div>

                <!-- Web Service Configuration -->
                <div class="col-md-6">
                    <h3>Web Service</h3>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="use_web" name="use_web"
                               {% if config.use_web %}checked{% endif %} value="1">
                        <label class="form-check-label" for="use_web">
                            Enable Messaging for Web Service
                        </label>
                    </div>
                    <div class="mb-3">
                        <label for="web_service_url" class="form-label">Web Service Server</label>
                        <input type="text" class="form-control" id="web_service_url" name="web_service_url"
                               placeholder="Web Service URL"
                               value="{{config.web_service_url}}">
                    </div>
                </div>
            </div>

            <!-- Notification Delay Slider -->
            <div class="row mt-4">
                <div class="col-12">
                    <label for="notificationDelay" class="form-label">Notification Delay: <span
                            id="notificationDelay">{{config.notification_delay}} seconds</span></label>
                    <input type="range" class="form-range" min="10" max="300" step="1" id="notification_delay"
                           name="notification_delay"
                           value="{{config.notification_delay}}"
                           oninput="updateDelayDisplay(this.value)">
                    <small class="text-muted">This is the time the server waits until it sends the message again for the
                        face recognition event. </small>
                </div>
            </div>

            <!-- Custom Message -->
            <div class="row mt-3">
                <div class="col-6">
                    <label for="custom_message_udp" class="form-label">Custom Message for UDP</label>
                    <textarea class="form-control" id="custom_message_udp" name="custom_message_udp" rows="3"
                              placeholder="Enter message with placeholders like [[name]], [[date]], [[time]]">{{config.custom_message_udp}}</textarea>
                    <small class="text-muted">Use [[name]], [[date]], [[time]], [[timestamp]], [[image_url]] as
                        placeholders in your
                        message.</small>
                </div>
                <div class="col-6">
                    <label for="custom_message_http" class="form-label">Custom Message for HTTP</label>
                    <textarea class="form-control" id="custom_message_http" name="custom_message_http" rows="3"
                              placeholder="Enter message with placeholders like [[name]], [[date]], [[time]]">{{config.custom_message_http}}</textarea>
                    <small class="text-muted">Use [[name]], [[date]], [[time]], [[timestamp]], [[image_url]] as
                        placeholders in your
                        message.</small>
                </div>
            </div>
        </form>
    </div>

    <div class="tab-pane fade" id="eventlog" role="tabpanel" aria-labelledby="eventlog-tab">
        <div class="my-3">
            <a href="{{ url_for('last_event_image') }}" target="_blank">Last event image</a>
        </div>

        <p class="alert alert-info">
            <b>Note:</b> The notification delay is used for event logging.
        </p>

        <!-- IMPORTANT:
             - No extra Save button here (use global "Save changes").
             - The input is attached to settings-form via form="settings-form" so it is included when saving. -->
        <div class="mb-3">
            <label class="form-label" for="eventimage_cleanup_days">Delete images older than (days)</label>

            <div class="input-group">
                <input type="number"
                       class="form-control"
                       id="eventimage_cleanup_days"
                       name="eventimage_cleanup_days"
                       min="0"
                       max="3650"
                       form="settings-form"
                       value="{{ config.get('eventimage_cleanup_days', 0) }}">
                <button type="button" id="cleanNowBtn" class="btn btn-danger">Clean now</button>
            </div>

            <small class="form-text text-muted">0 = disabled</small>
            <small class="form-text text-muted">Change the value and click <b>Save changes</b> at the bottom of the page.</small>

            <div id="cleanNowResult" class="small text-muted mt-2"></div>
        </div>

        <div id="eventlog-table"></div>
    </div>

</div>

<script>
function toggleFaceRecognitionInterval() {
  const cb = document.getElementById('enableFaceRecognitionInterval');
  const slider = document.getElementById('face_recognition_interval');
  if (!cb || !slider) return;
  slider.disabled = !cb.checked;

  // Stream suspend is only allowed if face recognition interval is disabled
  toggleStreamSuspendAvailability();
}

function toggleStreamSuspendAvailability() {
  const intervalCb = document.getElementById('enableFaceRecognitionInterval');
  const suspendCb = document.getElementById('enableStreamSuspend');
  if (!intervalCb || !suspendCb) return;

  if (intervalCb.checked) {
    suspendCb.checked = false;
    suspendCb.disabled = true;
  } else {
    suspendCb.disabled = false;
  }
}

document.addEventListener('DOMContentLoaded', function () {
  // Ensure the slider is correctly enabled/disabled on load
  toggleFaceRecognitionInterval();
  toggleStreamSuspendAvailability();

  // Clean now uses SAVED config only (your NEIN/NEIN requirement)
  const cleanBtn = document.getElementById('cleanNowBtn');
  const result = document.getElementById('cleanNowResult');

  if (cleanBtn) {
    cleanBtn.addEventListener('click', async function () {
      try {
        if (result) {
          result.textContent = 'Cleaning...';
          result.className = 'small text-muted mt-2';
        }

        const resp = await fetch('/clean_event_images', { method: 'POST' });
        const data = await resp.json().catch(() => ({}));

        if (!resp.ok) {
          const msg = (data && (data.message || data.error)) ? (data.message || data.error) : ('HTTP ' + resp.status);
          throw new Error(msg);
        }

        const deleted = (typeof data.deleted !== 'undefined') ? data.deleted : (data.count || 0);
        if (result) {
          result.textContent = `Done. Deleted ${deleted} image(s).`;
          result.className = 'small text-success mt-2';
        }
      } catch (e) {
        if (result) {
          result.textContent = 'Error: ' + (e && e.message ? e.message : e);
          result.className = 'small text-danger mt-2';
        }
      }
    });
  }

  // Loxone test button
  const btn = document.getElementById('loxone-test-btn');
  const out = document.getElementById('loxone-test-result');
  if (btn) {
    btn.addEventListener('click', async function () {
      if (out) {
        out.textContent = 'Sending...';
        out.className = 'ms-2 text-muted';
      }
      try {
        const resp = await fetch('/loxone-test', { method: 'POST' });
        const data = await resp.json().catch(() => ({}));
        if (resp.ok && data && data.status === 'ok') {
          if (out) {
            out.textContent = 'OK';
            out.className = 'ms-2 text-success';
          }
        } else {
          const msg = (data && data.message) ? data.message : ('HTTP ' + resp.status);
          if (out) {
            out.textContent = 'Error: ' + msg;
            out.className = 'ms-2 text-danger';
          }
        }
      } catch (e) {
        if (out) {
          out.textContent = 'Error: ' + (e && e.message ? e.message : e);
          out.className = 'ms-2 text-danger';
        }
      }
    });
  }
});
</script>
{% endblock %}
